name: Publish Test Reports to Pages Branch

on:
  workflow_run:
    workflows: ["Playwright CI (PR)"]
    types: [completed]

permissions:
  contents: write
  actions: read

jobs:
  publish:
    if: ${{ github.event.workflow_run.event == 'pull_request' }}
    runs-on: ubuntu-latest

    steps:
      - name: Download Playwright report artifact from triggering run
        env:
          GH_TOKEN: ${{ github.token }}
          RUN_ID: ${{ github.event.workflow_run.id }}
          REPO: ${{ github.repository }}
        run: |
          set -euo pipefail
          artifacts_json="$(gh api "repos/$REPO/actions/runs/$RUN_ID/artifacts")"
          artifact_id="$(echo "$artifacts_json" | jq -r '.artifacts[] | select(.name=="playwright-html-report") | .id' | head -n 1)"
          if [ -z "${artifact_id}" ] || [ "${artifact_id}" = "null" ]; then
            echo "Artifact 'playwright-html-report' not found. Nothing to publish."
            exit 0
          fi
          gh api "repos/$REPO/actions/artifacts/$artifact_id/zip" > report.zip
          mkdir -p playwright-report
          unzip -q report.zip -d playwright-report
          test -f playwright-report/index.html

      - name: Determine PR number (robust)
        id: pr
        env:
          GH_TOKEN: ${{ github.token }}
          RUN_ID: ${{ github.event.workflow_run.id }}
          REPO: ${{ github.repository }}
        run: |
          set -euo pipefail
          pr_num="$(gh api "repos/$REPO/actions/runs/$RUN_ID" --jq '.pull_requests[0].number // empty')"
          if [ -z "$pr_num" ]; then
            echo "Could not determine PR number. Skipping publish."
            exit 0
          fi
          echo "pr_num=$pr_num" >> "$GITHUB_OUTPUT"

      - name: Checkout Pages branch
        uses: actions/checkout@v4
        with:
          ref: ui-test-artifacts-gh-pages
          path: pages

      - name: Copy report into /test-reports/... and update latest
        env:
          RUN_ID: ${{ github.event.workflow_run.id }}
          PR_NUM: ${{ steps.pr.outputs.pr_num }}
        run: |
          set -euo pipefail
          DATE="$(date +'%d-%m-%Y')"
          TIME="$(date +'%H-%M-%S')"

          DEST="pages/test-reports/pr-${PR_NUM}/${DATE}/${TIME}/${RUN_ID}"
          mkdir -p "$DEST"
          cp -R playwright-report/* "$DEST/"

          LATEST="pages/test-reports/pr-${PR_NUM}/latest"
          rm -rf "$LATEST"
          mkdir -p "$LATEST"
          cp -R playwright-report/* "$LATEST/"

          if [ ! -f "pages/index.html" ]; then
            cat > pages/index.html <<'HTML'
          <!doctype html><html><head><meta charset="utf-8"><title>Test Reports</title></head>
          <body><h1>Test Reports</h1><p>Browse <a href="./test-reports/">./test-reports/</a></p></body></html>
          HTML
          fi

      - name: Prune reports older than 7 business days (Mon–Fri)
        run: |
          set -euo pipefail
          ROOT="pages/test-reports"
          n=7
          d="$(date +%Y-%m-%d)"
          count=0
          while [ $count -lt $n ]; do
            d="$(date -d "$d - 1 day" +%Y-%m-%d)"
            dow="$(date -d "$d" +%u)"
            if [ "$dow" -le 5 ]; then
              count=$((count+1))
            fi
          done
          cutoff_epoch="$(date -d "$d 00:00:00" +%s)"
          shopt -s nullglob
          for prdir in "$ROOT"/pr-*; do
            for datedir in "$prdir"/*; do
              base="$(basename "$datedir")"
              [ "$base" = "latest" ] && continue
              if epoch=$(date -d "$base 00:00:00" +%s 2>/dev/null); then
                [ "$epoch" -lt "$cutoff_epoch" ] && rm -rf "$datedir"
              fi
            done
          done

      - name: Commit & push Pages branch
        run: |
          set -euo pipefail
          cd pages
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add .
          if git diff --cached --quiet; then
            echo "No changes to publish."
            exit 0
          fi
          git commit -m "Publish test report (run ${{ github.event.workflow_run.id }})"
          git push origin HEAD:ui-test-artifacts-gh-pages

      - name: Slack notify (clean link to report index.html)
        if: always()
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
          GH_TOKEN: ${{ github.token }}
          REPO: ${{ github.repository }}
          SHA: ${{ github.event.workflow_run.head_sha }}
          PR_NUM: ${{ steps.pr.outputs.pr_num }}
        run: |
          set -euo pipefail

          # Find the matching Workflow A run by SHA to get true test conclusion
          runs_json="$(gh api "repos/$REPO/actions/workflows/playwright-ci-pages.yml/runs?event=pull_request&per_page=30")"
          conclusion="$(echo "$runs_json" | jq -r --arg sha "$SHA" '.workflow_runs[] | select(.head_sha==$sha) | .conclusion' | head -n 1)"
          run_url="$(echo "$runs_json" | jq -r --arg sha "$SHA" '.workflow_runs[] | select(.head_sha==$sha) | .html_url' | head -n 1)"

          if [ "$conclusion" = "success" ]; then emoji="✅"; label="PASS"
          elif [ "$conclusion" = "failure" ]; then emoji="❌"; label="FAIL"
          else emoji="⚪"; label="${conclusion:-UNKNOWN}"
          fi

          report_url="https://selvarajkuppusamy.github.io/playwright-mocking-lab/test-reports/pr-${PR_NUM}/latest/index.html"

          title="Playwright PR #${PR_NUM} — ${emoji} ${label}"

          payload="$(jq -n \
            --arg title "$title" \
            --arg report "$report_url" \
            --arg run "$run_url" \
            '{
              text: $title,
              blocks: [
                { "type": "section", "text": { "type": "mrkdwn", "text": ("*" + $title + "*") } },
                { "type": "section", "text": { "type": "mrkdwn", "text": ("• *HTML report:* <" + $report + "|Open report>\n• *Test run:* <" + $run + "|Open workflow run>") } }
              ]
            }')"

          curl -sS -X POST -H 'Content-type: application/json' --data "$payload" "$SLACK_WEBHOOK_URL"
