name: Publish Test Reports to Pages Branch

on:
  workflow_run:
    workflows: ["Playwright CI (PR)"]
    types: [completed]

permissions:
  contents: write
  actions: read

jobs:
  publish:
    if: ${{ github.event.workflow_run.event == 'pull_request' }}
    runs-on: ubuntu-latest

    outputs:
      pr_num: ${{ steps.pr.outputs.pr_num }}
      latest_url: ${{ steps.out.outputs.latest_url }}

    steps:
      - name: Download Playwright report artifact from triggering run
        env:
          GH_TOKEN: ${{ github.token }}
          RUN_ID: ${{ github.event.workflow_run.id }}
          REPO: ${{ github.repository }}
        run: |
          set -euo pipefail
          artifacts_json="$(gh api "repos/$REPO/actions/runs/$RUN_ID/artifacts")"
          artifact_id="$(echo "$artifacts_json" | jq -r '.artifacts[] | select(.name=="playwright-html-report") | .id' | head -n 1)"
          if [ -z "${artifact_id}" ] || [ "${artifact_id}" = "null" ]; then
            echo "Artifact 'playwright-html-report' not found. Nothing to publish."
            exit 0
          fi
          gh api "repos/$REPO/actions/artifacts/$artifact_id/zip" > report.zip
          mkdir -p playwright-report
          unzip -q report.zip -d playwright-report
          test -f playwright-report/index.html

      - name: Determine PR number from run
        id: pr
        env:
          GH_TOKEN: ${{ github.token }}
          RUN_ID: ${{ github.event.workflow_run.id }}
          REPO: ${{ github.repository }}
        run: |
          set -euo pipefail
          pr_num="$(gh api "repos/$REPO/actions/runs/$RUN_ID" --jq '.pull_requests[0].number // empty')"
          if [ -z "$pr_num" ]; then
            echo "Could not determine PR number. Skipping publish."
            exit 0
          fi
          echo "pr_num=$pr_num" >> "$GITHUB_OUTPUT"
          echo "PR number detected: $pr_num"

      - name: Checkout Pages branch
        uses: actions/checkout@v4
        with:
          ref: ui-test-artifacts-gh-pages
          path: pages

      - name: Copy report and update latest
        env:
          RUN_ID: ${{ github.event.workflow_run.id }}
          PR_NUM: ${{ steps.pr.outputs.pr_num }}
        run: |
          set -euo pipefail
          DATE="$(date +'%d-%m-%Y')"
          TIME="$(date +'%H-%M-%S')"

          DEST="pages/test-reports/pr-${PR_NUM}/${DATE}/${TIME}/${RUN_ID}"
          mkdir -p "$DEST"
          cp -R playwright-report/* "$DEST/"

          LATEST="pages/test-reports/pr-${PR_NUM}/latest"
          rm -rf "$LATEST"
          mkdir -p "$LATEST"
          cp -R playwright-report/* "$LATEST/"

          if [ ! -f "pages/index.html" ]; then
            cat > pages/index.html <<'HTML'
          <!doctype html><html><head><meta charset="utf-8"><title>Test Reports</title></head>
          <body><h1>Test Reports</h1><p>Browse <a href="./test-reports/">./test-reports/</a></p></body></html>
          HTML
          fi

      - name: Prune reports older than 7 business days (Monâ€“Fri)
        run: |
          set -euo pipefail
          ROOT="pages/test-reports"
          n=7
          d="$(date +%Y-%m-%d)"
          count=0
          while [ $count -lt $n ]; do
            d="$(date -d "$d - 1 day" +%Y-%m-%d)"
            dow="$(date -d "$d" +%u)"
            if [ "$dow" -le 5 ]; then
              count=$((count+1))
            fi
          done
          cutoff_epoch="$(date -d "$d 00:00:00" +%s)"
          shopt -s nullglob
          for prdir in "$ROOT"/pr-*; do
            for datedir in "$prdir"/*; do
              base="$(basename "$datedir")"
              [ "$base" = "latest" ] && continue
              if epoch=$(date -d "$base 00:00:00" +%s 2>/dev/null); then
                [ "$epoch" -lt "$cutoff_epoch" ] && rm -rf "$datedir"
              fi
            done
          done

      - name: Commit & push Pages branch
        run: |
          set -euo pipefail
          cd pages
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add .
          if git diff --cached --quiet; then
            echo "No changes to publish."
            exit 0
          fi
          git commit -m "Publish test report (run ${{ github.event.workflow_run.id }})"
          git push origin HEAD:ui-test-artifacts-gh-pages

      - name: Expose latest report URL (job output)
        id: out
        env:
          PR_NUM: ${{ steps.pr.outputs.pr_num }}
        run: |
          set -euo pipefail
          base="https://selvarajkuppusamy.github.io/playwright-mocking-lab"
          latest_url="${base}/test-reports/pr-${PR_NUM}/latest/"
          echo "latest_url=$latest_url" >> "$GITHUB_OUTPUT"
          echo "Latest report URL: $latest_url"
