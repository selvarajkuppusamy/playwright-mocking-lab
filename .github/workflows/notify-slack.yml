name: Notify Slack (Test Reports)

on:
  workflow_run:
    workflows: ["Publish Test Reports to Pages Branch"]
    types: [completed]

permissions:
  contents: read
  actions: read

jobs:
  notify:
    runs-on: ubuntu-latest

    steps:
      - name: Build message details
        id: meta
        env:
          GH_TOKEN: ${{ github.token }}
          RUN_ID: ${{ github.event.workflow_run.id }}
          REPO: ${{ github.repository }}
        run: |
          set -euo pipefail

          # Pull PR number for this workflow run (robust via API)
          pr_num="$(gh api "repos/$REPO/actions/runs/$RUN_ID" --jq '.pull_requests[0].number // empty')"

          conclusion="${{ github.event.workflow_run.conclusion }}"
          run_url="${{ github.event.workflow_run.html_url }}"

          # If for some reason PR number isn't present, still notify with run URL.
          if [ -z "$pr_num" ]; then
            report_url="(PR not detected)"
          else
            report_url="https://selvarajkuppusamy.github.io/playwright-mocking-lab/test-reports/pr-${pr_num}/latest/"
          fi

          echo "pr_num=$pr_num" >> "$GITHUB_OUTPUT"
          echo "conclusion=$conclusion" >> "$GITHUB_OUTPUT"
          echo "run_url=$run_url" >> "$GITHUB_OUTPUT"
          echo "report_url=$report_url" >> "$GITHUB_OUTPUT"

      - name: Send Slack notification
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
          PR_NUM: ${{ steps.meta.outputs.pr_num }}
          CONCLUSION: ${{ steps.meta.outputs.conclusion }}
          RUN_URL: ${{ steps.meta.outputs.run_url }}
          REPORT_URL: ${{ steps.meta.outputs.report_url }}
        run: |
          set -euo pipefail

          # Simple formatting
          if [ "$CONCLUSION" = "success" ]; then
            status="✅ PASS"
          elif [ "$CONCLUSION" = "failure" ]; then
            status="❌ FAIL"
          else
            status="⚪ $CONCLUSION"
          fi

          if [ -n "${PR_NUM:-}" ]; then
            title="Playwright PR #${PR_NUM} — ${status}"
          else
            title="Playwright — ${status}"
          fi

          payload="$(jq -n \
            --arg title "$title" \
            --arg report "$REPORT_URL" \
            --arg run "$RUN_URL" \
            '{
              text: $title,
              blocks: [
                { "type": "section", "text": { "type": "mrkdwn", "text": ("*" + $title + "*") } },
                { "type": "section", "text": { "type": "mrkdwn", "text": ("• *HTML report:* " + $report + "\n• *Workflow run:* " + $run) } }
              ]
            }')"

          curl -sS -X POST -H 'Content-type: application/json' --data "$payload" "$SLACK_WEBHOOK_URL"
